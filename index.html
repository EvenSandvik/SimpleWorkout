<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#40df64" />
  <meta name="description" content="Track your workouts and monitor your progress" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Workout Tracker</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <link rel="icon" type="image/png" href="/icon-192.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: "Work Sans", Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f7ff;
      color: #222;
      margin: 2em;
    }

    h1 {
      text-align: center;
      margin-bottom: 1em;
    }

    #addExerciseForm {
      max-width: 400px;
      margin: 0 auto 2em auto;
      display: flex;
      gap: 0.5em;
    }

    #exerciseName {
      flex-grow: 1;
      padding: 1em 1.5em;
      font-size: 0.84em;
      border: 0px solid #fff;
      border-radius: 15px;
      transition: border-color 0.2s ease-in-out;
    }
    #exerciseName:focus {
      outline: none;
      border-color: #343434;
    }

    #addExerciseBtn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 0 1.7em;
      margin-left: 0.5em;
      font-weight: 600;
      font-size: 1em;
      background-color: #343434;
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.25s ease-in-out;
    }
    #addExerciseBtn svg {
      stroke: white;
    }
    #addExerciseBtn:hover:not(:disabled) {
      background-color: #2563eb;
    }
    #addExerciseBtn:disabled {
      background-color: #343434;
      cursor: not-allowed;
    }
    
    .exercise-header {
      background-color: #343434;
      color: white;
      border-radius: 0 0 10px 10px;
      width: fit-content;
      padding: 0.5em 1em;
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1em;
      font-weight: normal;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 30px;
      overflow: hidden;
    }
    thead {
      background-color: #343434;
      font-weight: 700;
    }
    th, td {
      padding: 0.75em 1em;
      text-align: center;
    }
    tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }
    tbody tr:hover {
      
    }

    input[type="number"] {
      width: 20px;
      padding: 0.25em 0.4em;
      font-size: 1em;
      border: 1.5px solid #ddd;
      border-radius: 30px;
      text-align: center;
      transition: border-color 0.2s ease-in-out;
    }
    input[type="number"]:focus {
      border-color: #343434;
      outline: none;
    }

    button.saveBtn {
      background-color: #40df64;
      color: white;
      border: none;
      padding: 0.35em 0.9em;
      font-weight: 600;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s ease-in-out;
    }
    button.saveBtn:hover:not(:disabled) {
      background-color: #50df64;
    }
    button.saveBtn:disabled {
      background-color: #6ee7b7;
      cursor: not-allowed;
    }

    .improvement {
      font-weight: 700;
    }
    .improvement.positive {
      color: #059669;
    }
    .improvement.negative {
      color: #ef4444;
    }
    .improvement.neutral {
      color: #6b7280;
    }

    #snackbar {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 30px;
      padding: 1em;
      position: fixed;
      bottom: 2em;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
      font-weight: 600;
    }
    #snackbar.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }
    @keyframes fadein {
      from {bottom: 0; opacity: 0;}
      to {bottom: 2em; opacity: 1;}
    }
    @keyframes fadeout {
      from {bottom: 2em; opacity: 1;}
      to {bottom: 0; opacity: 0;}
    }

    #historyModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 10;
      justify-content: center;
      align-items: center;
    }
    #historyModal > div {
      background: white;
      padding: 1.5em;
      border-radius: 10px;
      margin: 1em;
      max-width: 600px;
      width: 90%;
      position: relative;
    }

    #historyModal button.closeBtn {
      position: absolute;
      top: 0.5em;
      right: 0.5em;
      font-size: 1.2em;
      background: none;
      border: none;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        display: none;
      }
      #workoutTable {
      margin-bottom: 70px; /* Add space for the navigation */
    }

    /* Navigation Styles */
    .nav-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: #343434;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      padding: 10px 0;
      margin: 1rem 2rem;
      z-index: 100;
      border-radius: 999px;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: white;
      padding: 8px 0;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0 1rem;
    }

    .nav-btn svg {
      margin-bottom: 4px;
      stroke: currentColor;
    }

    .nav-btn span {
      font-size: 0.8em;
      font-weight: 500;
    }

    .nav-btn.active {
      background: #40df64;
      border-radius: 999px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* Progress Page Styles */
    .progress-container {
      padding: 1.5em;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .time-range-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 2em;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .time-range-btn {
      padding: 0.5em 1em;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s ease;
    }
    
    .time-range-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #343434;
    }
    
    .chart-section {
      background: white;
      border-radius: 15px;
      padding: 1.5em;
      margin-bottom: 2em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .chart-section h3 {
      margin-top: 0;
      margin-bottom: 1.5em;
      color: #1f2937;
      font-size: 1.2em;
    }
    
    .chart-container {
      position: relative;
      width: 100%;
      height: 300px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5em;
      margin-bottom: 2em;
    }
    
    .stats-card {
      background: white;
      border-radius: 15px;
      padding: 1.5em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .stats-card h3 {
      margin-top: 0;
      margin-bottom: 1em;
      color: #1f2937;
      font-size: 1.1em;
    }
    
    .exercise-section {
      margin-bottom: 2em;
      background: white;
      border-radius: 30px;
      padding: 0 1.5em 1.5em 1.5em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .exercise-selector {
      margin-bottom: 1.5em;
    }
    
    .exercise-dropdown {
      width: 100%;
      padding: 0.75em 1em;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1em;
      background: white;
    }

    .progress-container h2 {
      color: #1f2937;
      margin-bottom: 1.5em;
      text-align: center;
    }

    #progressChartContainer {
      position: relative;
      width: 100%;
      height: 400px;
      margin-bottom: 2em;
      background: white;
      border-radius: 15px;
      padding: 1.5em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    @media (max-width: 768px) {
      .progress-container {
        padding: 1em;
      }
      
      #progressChartContainer {
        height: 300px;
        padding: 1em;
      }
    }
      tbody tr {
        margin-bottom: 1.5em;
        border-radius: 30px;
        padding: 1em;
        background: white;
      }
      tbody tr td {
        padding: 0.5em 1em;
        text-align: left;
        position: relative;
        padding-left: 50%;
        border: none;
        border-bottom: 1px solid #eee;
      }
      tbody tr td::before {
        content: attr(data-label);
        position: absolute;
        left: 1em;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 700;
        color: #555;
        width: 45%;
      }
      tbody tr td:last-child {
        border: none;
        text-align: right;
        padding-right: 1em;
      }
      input[type="number"] {
        width: 100%;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
<h2 style="color: #343434; font-size: 1.8em;"><span id="displayName"></span></h2>
  <form id="addExerciseForm" onsubmit="event.preventDefault(); addExercise();">
    <input id="exerciseName" type="text" placeholder="New exercise" autocomplete="off" />
    <button id="addExerciseBtn" disabled>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Add
    </button>
  </form>

  <!-- Pages Container -->
  <div id="pages">
    <!-- Tracker Page (default active) -->
    <div id="tracker-page" class="page active">
      <div id="workoutTable"></div>
    </div>
    
    <!-- Progress Page -->
    <div id="progress-page" class="page">
      <div class="progress-container">
        <h2>Workout Progress</h2>
        
        <!-- Time Range Selector -->
        <div class="time-range-selector">
          <button class="time-range-btn active" data-range="7">Week</button>
          <button class="time-range-btn" data-range="30">Month</button>
          <button class="time-range-btn" data-range="90">3 Months</button>
          <button class="time-range-btn" data-range="365">Year</button>
          <button class="time-range-btn" data-range="all">All Time</button>
        </div>
        
        <!-- Volume Progress -->
        <div class="chart-section">
          <h3>Volume Over Time</h3>
          <div class="chart-container">
            <canvas id="volumeChart"></canvas>
          </div>
        </div>
        
        <div class="stats-grid">
          <!-- Exercise Selector -->
          <div class="exercise-selector">
            <h3>Exercise</h3>
            <select id="exerciseSelect" class="exercise-dropdown">
              <option value="all">All Exercises</option>
              <!-- Dynamically populated -->
            </select>
          </div>
          
          <!-- Personal Bests -->
          <div class="stats-card">
            <h3>üèÜ Personal Bests</h3>
            <div id="personalBests"></div>
          </div>
          
          <!-- Recent Progress -->
          <div class="stats-card">
            <h3>üìà Recent Progress</h3>
            <div id="recentProgress"></div>
          </div>
        </div>
        
        <!-- Exercise-Specific Chart -->
        <div class="chart-section">
          <h3>Exercise Performance</h3>
          <div class="chart-container">
            <canvas id="exerciseChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="snackbar">Saved!</div>

  <div id="historyModal">
    <div>
      <button class="closeBtn" onclick="closeModal()">√ó</button>
      <canvas id="historyChart" width="500" height="300"></canvas>
    </div>
  </div>

  <!-- Floating Navigation -->
  <div class="nav-container">
    <button class="nav-btn active" data-page="tracker" title="Workout Tracker">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      <span>Tracker</span>
    </button>
    <button class="nav-btn" data-page="progress" title="Progress & Stats">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="20" x2="12" y2="10"></line>
        <line x1="18" y1="20" x2="18" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="16"></line>
      </svg>
      <span>Progress</span>
    </button>
  </div>

  <script>
    const workoutsKey = 'workouts';
    let workouts = JSON.parse(localStorage.getItem(workoutsKey)) || [];
    const exerciseInput = document.getElementById('exerciseName');
    const addExerciseBtn = document.getElementById('addExerciseBtn');

    exerciseInput.addEventListener('input', () => {
      addExerciseBtn.disabled = exerciseInput.value.trim() === '';
    });

    function saveWorkouts() {
      localStorage.setItem(workoutsKey, JSON.stringify(workouts));
    }

    function showSnackbar(message = 'Saved!') {
      const snackbar = document.getElementById('snackbar');
      snackbar.textContent = message;
      snackbar.className = 'show';
      setTimeout(() => snackbar.className = snackbar.className.replace('show', ''), 3000);
    }

    function formatDate(isoString) {
      const d = new Date(isoString);
      return d.toLocaleDateString(undefined, { year: '2-digit', month: 'short', day: 'numeric' });
    }

    function calculateImprovement(curr, prev) {
      const weightDiff = curr.weight - prev.weight;
      const repsDiff = curr.reps - prev.reps;
      const setsDiff = curr.sets - prev.sets;

      let parts = [];
      if (weightDiff !== 0)
        parts.push(`<span class="improvement ${weightDiff > 0 ? 'positive' : 'negative'}">Weight: ${weightDiff > 0 ? '+' : ''}${weightDiff}kg</span>`);
      if (repsDiff !== 0)
        parts.push(`<span class="improvement ${repsDiff > 0 ? 'positive' : 'negative'}">Reps: ${repsDiff > 0 ? '+' : ''}${repsDiff}</span>`);
      if (setsDiff !== 0)
        parts.push(`<span class="improvement ${setsDiff > 0 ? 'positive' : 'negative'}">Sets: ${setsDiff > 0 ? '+' : ''}${setsDiff}</span>`);

      return parts.length === 0 ? '<span class="improvement neutral">No change</span>' : parts.join(', ');
    }

    function formatExerciseName(name) {
      return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
    }

    function renderTable() {
      const container = document.getElementById('workoutTable');
      container.innerHTML = '';

      const grouped = {};
      workouts.forEach(w => {
        if (!grouped[w.exercise]) grouped[w.exercise] = [];
        grouped[w.exercise].push(w);
      });

      Object.keys(grouped).forEach(exercise => {
        const formattedExercise = formatExerciseName(exercise);
        const records = grouped[exercise].sort((a,b) => new Date(a.date) - new Date(b.date));
        const last = records[records.length - 1];
        const prev = records.length > 1 ? records[records.length - 2] : null;

        const exerciseSection = document.createElement('div');
        exerciseSection.className = 'exercise-section';
        exerciseSection.innerHTML = `
          <table class="exercise-table">
            <thead>
              <tr>
                <th><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path></svg> Sets</th>
                <th><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> Reps</th>
                <th><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V2"></path><line x1="6" y1="2" x2="18" y2="2"></line><path d="M6 10h12"></path><path d="M6 6h12"></path><path d="M6 14h12"></path><path d="M6 18h12"></path></svg> Weight (kg)</th>
                <th><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> Actions</th>
              </tr>
            </thead>
            <h2 class="exercise-header">${formattedExercise}</h2>
            <tbody>
              <tr>
                <td data-label="Sets"><input type="number" min="1" id="sets-${exercise}" value="${last.sets}" /></td>
                <td data-label="Reps"><input type="number" min="1" id="reps-${exercise}" value="${last.reps}" /></td>
                <td data-label="Weight (kg)"><input type="number" min="0" step="0.5" id="weight-${exercise}" value="${last.weight}" /></td>
                <td data-label="Improvement">${prev ? calculateImprovement(last, prev) : '<span class="improvement neutral">N/A</span>'}</td>
                <td data-label="Last Date">${formatDate(last.date)}</td>
               
              </tr>
            </tbody>
          </table>
          <div data-label="" style="display: flex; flex-direction: row; gap: 0.7em; width: 100%;">
                  <button class="saveBtn" style="margin-top: 0.5em; padding: 0.5em 1em; display: flex; align-items: center; gap: 5px;" onclick="saveEntry('${exercise}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                      <polyline points="17 21 17 13 7 13 7 21"></polyline>
                      <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                  </button>
                  <button class="saveBtn" style="margin-top: 0.5em; background-color: #343434; display: flex; align-items: center; gap: 5px;" onclick="viewHistory('${exercise}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="1 4 1 10 7 10"></polyline>
                      <polyline points="23 20 23 14 17 14"></polyline>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    History
                  </button>
                </div>
        `;
        container.appendChild(exerciseSection);
      });
    }

    function addExercise() {
      const name = exerciseInput.value.trim();
      if (!name) return;
      if (workouts.some(w => w.exercise.toLowerCase() === name.toLowerCase())) {
        alert('Exercise already exists.');
        return;
      }

      workouts.push({
        exercise: name,
        date: new Date().toISOString(),
        sets: 3,
        reps: 10,
        weight: 0
      });

      saveWorkouts();
      renderTable();
      exerciseInput.value = '';
      addExerciseBtn.disabled = true;
      showSnackbar(`Added exercise "${name}"`);
    }

    function saveEntry(exercise) {
      const sets = parseInt(document.getElementById(`sets-${exercise}`).value);
      const reps = parseInt(document.getElementById(`reps-${exercise}`).value);
      const weight = parseFloat(document.getElementById(`weight-${exercise}`).value);

      if (isNaN(sets) || sets < 1 || isNaN(reps) || reps < 1 || isNaN(weight) || weight < 0) {
        alert('Please enter valid numbers.');
        return;
      }

      workouts.push({
        exercise,
        date: new Date().toISOString(),
        sets,
        reps,
        weight
      });

      saveWorkouts();
      renderTable();
      showSnackbar(`Saved "${exercise}"`);
    }

    let chartInstance;
    function viewHistory(exerciseName) {
      const history = workouts
        .filter(w => w.exercise === exerciseName)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      const labels = history.map(w => formatDate(w.date));
      const weights = history.map(w => w.weight);

      const ctx = document.getElementById('historyChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: `${exerciseName} Weight (kg)`,
            data: weights,
            borderColor: '#40df64',
            backgroundColor: 'rgba(64,223,100,0.2)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });

      document.getElementById('historyModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('historyModal').style.display = 'none';
    }

    // User display name functions
    function checkDisplayName() {
      const userName = localStorage.getItem('userDisplayName');
      if (!userName) {
        document.getElementById('displayNameModal').style.display = 'flex';
      } else {
        updateWelcomeMessage(userName);
      }
    }

    function saveDisplayName() {
      const nameInput = document.getElementById('userDisplayName');
      const name = nameInput.value.trim();
      
      if (name) {
        localStorage.setItem('userDisplayName', name);
        document.getElementById('displayNameModal').style.display = 'none';
        updateWelcomeMessage(name);
      } else {
        nameInput.setCustomValidity('Please enter your name');
        nameInput.reportValidity();
      }
    }

    function updateWelcomeMessage(name) {
      const displayNameElement = document.getElementById('displayName');
      if (displayNameElement) {
        displayNameElement.textContent = name;
      }
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      checkDisplayName();
      renderTable();
      setupNavigation();
      
      // Add event listeners for time range buttons
      document.querySelectorAll('.time-range-btn').forEach(button => {
        button.addEventListener('click', function() {
          document.querySelectorAll('.time-range-btn').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          selectedTimeRange = this.getAttribute('data-range');
          updateProgressPage();
        });
      });
      
      // Add event listener for exercise selector
      const exerciseSelect = document.getElementById('exerciseSelect');
      if (exerciseSelect) {
        exerciseSelect.addEventListener('change', function() {
          selectedExercise = this.value;
          updateProgressPage();
        });
      }
    });
    
    // Setup event listeners when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Time range buttons
      document.querySelectorAll('.time-range-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          selectedTimeRange = this.dataset.range;
          updateProgressPage();
        });
      });
      
      // Exercise selector
      const exerciseSelect = document.getElementById('exerciseSelect');
      if (exerciseSelect) {
        exerciseSelect.addEventListener('change', function() {
          selectedExercise = this.value;
          updateProgressPage();
        });
      }
      
      // Update progress page when switching to it
      document.querySelector('[data-page="progress"]').addEventListener('click', () => {
        setTimeout(updateProgressPage, 100);
      });
    });
    
    function setupNavigation() {
      const navButtons = document.querySelectorAll('.nav-btn');
      const pages = document.querySelectorAll('.page');
      
      navButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetPage = button.getAttribute('data-page');
          
          // Update active button
          navButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Show target page
          pages.forEach(page => page.classList.remove('active'));
          const targetPageElement = document.getElementById(`${targetPage}-page`);
          if (targetPageElement) {
            targetPageElement.classList.add('active');
          }
          
          // If progress page is selected, update the chart
          if (targetPage === 'progress') {
            setTimeout(updateProgressPage, 100);
          }
        });
      });
    }
    
    // Global chart instances
    let volumeChart, exerciseChart;
    let selectedExercise = 'all';
    let selectedTimeRange = '30'; // Default to 30 days
    
    function updateProgressPage() {
      try {
        // Make sure we're on the progress page
        const progressPage = document.getElementById('progress-page');
        if (!progressPage || !progressPage.classList.contains('active')) {
          return;
        }
        
        updateExerciseSelector();
        renderVolumeChart();
        renderExerciseChart();
        updatePersonalBests();
        updateRecentProgress();
      } catch (error) {
        console.error('Error updating progress page:', error);
      }
    }
    
    function updateExerciseSelector() {
      const select = document.getElementById('exerciseSelect');
      if (!select) return;
      
      // Make sure workouts is defined and is an array
      if (!Array.isArray(workouts) || workouts.length === 0) {
        select.innerHTML = '<option value="all">No exercises found</option>';
        return;
      }
      
      const exercises = new Set(workouts.map(w => w.exercise).sort());
      
      // Save current selection
      const currentSelection = select.value;
      
      // Clear and repopulate
      select.innerHTML = '<option value="all">All Exercises</option>';
      
      exercises.forEach(exercise => {
        if (exercise) { // Make sure exercise is not undefined
          const option = document.createElement('option');
          option.value = exercise;
          option.textContent = formatExerciseName(exercise);
          select.appendChild(option);
        }
      });
      
      // Restore selection if it still exists
      if (currentSelection && Array.from(select.options).some(opt => opt.value === currentSelection)) {
        select.value = currentSelection;
      } else {
        select.value = 'all';
      }
      
      selectedExercise = select.value;
    }
    
    function renderVolumeChart() {
      const canvas = document.getElementById('volumeChart');
      if (!canvas) return;
      
      // Clear any existing chart
      if (window.volumeChart && typeof window.volumeChart.destroy === 'function') {
        window.volumeChart.destroy();
      }
      
      const timeRange = getTimeRange();
      
      // Filter and process data
      const exerciseData = processExerciseData(timeRange, selectedExercise === 'all' ? null : selectedExercise);
      
      // Prepare chart data
      const datasets = [];
      const colors = [
        '#40df64', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
        '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#d946ef'
      ];
      
      Object.entries(exerciseData).forEach(([exercise, data], index) => {
        if (selectedExercise !== 'all' && exercise !== selectedExercise) return;
        
        // Sort data by date
        const sortedData = [...data].sort((a, b) => a.date - b.date);
        
        datasets.push({
          label: formatExerciseName(exercise),
          data: sortedData.map(entry => ({
            x: entry.date,
            y: entry.volume
          })),
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length] + '20',
          borderWidth: 2,
          tension: 0.3,
          fill: true
        });
      });
      
      // Create chart if we have data
      if (datasets.length > 0) {
        try {
          window.volumeChart = new Chart(canvas, {
            type: 'line',
            data: { datasets },
            options: getChartOptions('Volume (kg)')
          });
        } catch (error) {
          console.error('Error creating volume chart:', error);
          canvas.parentElement.innerHTML = '<p>Error displaying chart. Please try again.</p>';
        }
      } else {
        // Show message when no data is available
        canvas.parentElement.innerHTML = '<p>No data available for the selected time range and exercise.</p>';
      }
    }
    
    function renderExerciseChart() {
      const canvas = document.getElementById('exerciseChart');
      if (!canvas) return;
      
      const timeRange = getTimeRange();
      
      // Filter and process data
      const exerciseData = processExerciseData(timeRange, selectedExercise === 'all' ? null : selectedExercise);
      
      // Clear previous chart if it exists
      if (window.exerciseChart) {
        window.exerciseChart.destroy();
      }
      
      if (Object.keys(exerciseData).length === 0) {
        canvas.parentElement.innerHTML = '<p>No exercise data available for the selected time range.</p>';
        return;
      }
      
      // Get data for the selected exercise or first available exercise
      const exercise = selectedExercise === 'all' ? Object.keys(exerciseData)[0] : selectedExercise;
      const data = exerciseData[exercise] || [];
      
      if (data.length === 0) {
        canvas.parentElement.innerHTML = '<p>No data available for the selected exercise.</p>';
        return;
      }
      
      // Sort data by date
      const sortedData = [...data].sort((a, b) => a.date - b.date);
      
      // Prepare chart data
      const labels = sortedData.map(entry => formatDate(entry.date));
      const weightData = sortedData.map(entry => entry.weight);
      const volumeData = sortedData.map(entry => entry.volume);
      
      // Create chart
      window.exerciseChart = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Weight (kg)',
              data: weightData,
              backgroundColor: 'rgba(64, 223, 100, 0.7)',
              borderColor: 'rgba(64, 223, 100, 1)',
              borderWidth: 1,
              yAxisID: 'y',
              barPercentage: 0.7
            },
            {
              label: 'Volume (kg)',
              data: volumeData,
              type: 'line',
              borderColor: 'rgba(52, 52, 52, 1)',
              backgroundColor: 'rgba(52, 52, 52, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += context.parsed.y.toFixed(1) + ' kg';
                  }
                  return label;
                }
              }
            },
            legend: {
              position: 'top',
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Date'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Weight (kg)'
              },
              grid: {
                drawOnChartArea: true,
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Volume (kg)'
              },
              grid: {
                drawOnChartArea: false,
              }
            }
          }
        }
      });
    }
    
    function updatePersonalBests() {
      const container = document.getElementById('personalBests');
      if (!container) return;
      
      const exercise = selectedExercise === 'all' ? null : selectedExercise;
      const exerciseData = processExerciseData('all', exercise);
      
      if (Object.keys(exerciseData).length === 0) {
        container.innerHTML = '<p>No data available</p>';
        return;
      }
      
      let html = '';
      
      Object.entries(exerciseData).forEach(([ex, data]) => {
        if (data.length === 0) return;
        
        const maxVolume = Math.max(...data.map(d => d.volume));
        const maxWeight = Math.max(...data.map(d => d.weight));
        const maxVolumeEntry = data.find(d => d.volume === maxVolume);
        const maxWeightEntry = data.find(d => d.weight === maxWeight);
        
        html += `
          <div class="pb-entry">
            <strong>${formatExerciseName(ex)}</strong>
            <div>üèãÔ∏è Max Volume: ${maxVolume} kg (${maxVolumeEntry.sets}√ó${maxVolumeEntry.reps})</div>
            <div>üí™ Max Weight: ${maxWeight} kg (${maxWeightEntry.sets}√ó${maxWeightEntry.reps})</div>
          </div>
          <hr style="margin: 0.5em 0; border: 0; border-top: 1px solid #eee;">
        `;
      });
      
      container.innerHTML = html || '<p>No personal bests yet</p>';
    }
    
    function updateRecentProgress() {
      const container = document.getElementById('recentProgress');
      if (!container) return;
      
      const exercise = selectedExercise === 'all' ? null : selectedExercise;
      const exerciseData = processExerciseData('30', exercise); // Last 30 days
      
      if (Object.keys(exerciseData).length === 0) {
        container.innerHTML = '<p>No recent data</p>';
        return;
      }
      
      let html = '';
      
      Object.entries(exerciseData).forEach(([ex, data]) => {
        if (data.length < 2) return;
        
        const first = data[0];
        const last = data[data.length - 1];
        const volumeChange = ((last.volume - first.volume) / first.volume * 100).toFixed(1);
        const weightChange = ((last.weight - first.weight) / first.weight * 100).toFixed(1);
        
        html += `
          <div class="progress-entry">
            <strong>${formatExerciseName(ex)}</strong>
            <div>üìà Volume: ${volumeChange >= 0 ? '+' : ''}${volumeChange}%</div>
            <div>‚öñÔ∏è Weight: ${weightChange >= 0 ? '+' : ''}${weightChange}%</div>
          </div>
          <hr style="margin: 0.5em 0; border: 0; border-top: 1px solid #eee;">
        `;
      });
      
      container.innerHTML = html || '<p>No progress data available</p>';
    }
    
    // Helper functions
    function processExerciseData(timeRange = '30', specificExercise = null) {
      const now = new Date();
      let cutoffDate = new Date();
      
      if (timeRange !== 'all') {
        cutoffDate.setDate(now.getDate() - parseInt(timeRange));
      } else {
        cutoffDate = new Date(0); // Beginning of time
      }
      
      const exerciseData = {};
      
      // Make sure workouts is defined and is an array
      if (!Array.isArray(workouts)) {
        console.error('Workouts data is not properly initialized');
        return {};
      }
      
      workouts.forEach(workout => {
        // Filter by exercise if specified
        if (specificExercise && workout.exercise !== specificExercise) return;
        
        const workoutDate = new Date(workout.date);
        if (workoutDate < cutoffDate) return;
        
        if (!exerciseData[workout.exercise]) {
          exerciseData[workout.exercise] = [];
        }
        
        exerciseData[workout.exercise].push({
          date: workoutDate,
          weight: workout.weight,
          sets: workout.sets,
          reps: workout.reps,
          volume: workout.weight * workout.sets * workout.reps
        });
      });
      
      // Sort each exercise's data by date
      Object.values(exerciseData).forEach(data => {
        data.sort((a, b) => a.date - b.date);
      });
      
      return exerciseData;
    }
    
    function getTimeRange() {
      return selectedTimeRange;
    }
    
    function getChartOptions(yAxisLabel) {
      return {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: selectedTimeRange === '7' ? 'day' : 'week',
              tooltipFormat: 'MMM d, yyyy',
              displayFormats: {
                day: 'MMM d',
                week: 'MMM d',
                month: 'MMM yyyy'
              }
            },
            title: { display: true, text: 'Date' }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: yAxisLabel }
          }
        },
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const data = context.raw;
                return [
                  `Weight: ${data.y} kg`,
                  `Sets: ${data.sets || 'N/A'}`,
                  `Reps: ${data.reps || 'N/A'}`,
                  `Volume: ${(data.sets * data.reps * data.y).toFixed(1)} kg`
                ];
              }
            }
          }
        }
      };
    }
      
      // Make sure exerciseData is initialized
      const exerciseData = {};
      
      workouts.forEach(workout => {
        if (!exerciseData[workout.exercise]) {
          exerciseData[workout.exercise] = [];
        }
        exerciseData[workout.exercise].push({
          date: new Date(workout.date),
          weight: workout.weight,
          sets: workout.sets,
          reps: workout.reps,
          volume: workout.weight * workout.sets * workout.reps
        });
      });
      
      // Sort each exercise's data by date
      Object.keys(exerciseData).forEach(exercise => {
        exerciseData[exercise].sort((a, b) => a.date - b.date);
      });
      
      // Prepare chart data
      const datasets = [];
      const colors = [
        '#40df64', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
        '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#d946ef'
      ];
      
      Object.keys(exerciseData).forEach((exercise, index) => {
        const data = exerciseData[exercise];
        const color = colors[index % colors.length];
        
        datasets.push({
          label: exercise,
          data: data.map(entry => ({
            x: entry.date,
            y: entry.volume
          })),
          borderColor: color,
          backgroundColor: color + '20',
          borderWidth: 2,
          tension: 0.3,
          fill: true
        });
      });
      
      // Create or update chart
      if (window.progressChart) {
        window.progressChart.data.datasets = datasets;
        window.progressChart.update();
      } else {
        window.progressChart = new Chart(ctx, {
          type: 'line',
          data: { datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'day',
                  tooltipFormat: 'MMM d, yyyy'
                },
                title: {
                  display: true,
                  text: 'Date'
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Volume (kg)'
                }
              }
            },
            interaction: {
              intersect: false,
              mode: 'index'
            }
          }
        });
      
    }
  </script>
  <!-- Display Name Modal -->
  <div id="displayNameModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>Welcome to Workout Tracker! üëã</h2>
      <p>Please enter your name to personalize your experience.</p>
      <div style="margin: 1.5rem 0;">
        <input type="text" id="userDisplayName" placeholder="Your name" class="modal-input" autofocus />
      </div>
      <button onclick="saveDisplayName()" class="btn-primary">Save</button>
    </div>
  </div>

  <style>
    .modal {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      width: 100%;
      max-width: 450px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal h2 {
      margin-top: 0;
      color: var(--text-primary);
    }

    .modal p {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }

    .modal-input {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(64, 223, 100, 0.2);
    }
    .btn-outline:hover {
      background: rgba(64, 223, 100, 0.1);
    }
    
    .app-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .app-header h1 {
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }
    
    .welcome-message {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin: 0;
      font-weight: 400;
    }
  </style>
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.error('ServiceWorker registration failed: ', err);
          });
      });
    }

    // Handle PWA installation
    let deferredPrompt;
    const addBtn = document.querySelector('.add-to-homescreen');
    
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent Chrome 67 and earlier from automatically showing the prompt
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      // Show the install button if it exists
      if (addBtn) {
        addBtn.style.display = 'block';
        addBtn.addEventListener('click', () => {
          // Show the install prompt
          deferredPrompt.prompt();
          // Wait for the user to respond to the prompt
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the install prompt');
            } else {
              console.log('User dismissed the install prompt');
            }
            deferredPrompt = null;
          });
        });
      }
    });

    // Track if the app is running as a PWA
    window.addEventListener('appinstalled', (evt) => {
      console.log('App was installed as a PWA');
      // Hide the install button if it exists
      if (addBtn) addBtn.style.display = 'none';
    });

    // Check if the app is running in standalone mode
    function isRunningStandalone() {
      return (window.matchMedia('(display-mode: standalone)').matches) || 
             (window.navigator.standalone) || 
             document.referrer.includes('android-app://');
    }
  </script>
</body>
</html>
